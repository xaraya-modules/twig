{# @mail/admin/modifyconfig.html.twig #}

{% block modifyconfig %}
{{ xar_javascript({position: "head", scope: "theme", filename: "formcheck.js"}) }}
    <script type="text/javascript">
    {#  
        // Enter name of mandatory fields
        var mail_fieldRequired = Array("adminname", "adminmail");
        // Enter field description to appear in the dialog box
        var mail_fieldDescription = Array("Admin Name", "Admin Email");
    // #}
    </script>
    {{ include('@mail/includes/admin-mod-head.html.twig') }}
    <div class="xar-mod-body">
        <h2>Modify Mail Configuration</h2>
        {% set xmldata = 'modifyconfig' %}
        {{ include('@base/includes/admin-menu-skel.html.twig') }}
        
        <form method="post" action="{{ xar_currenturl() }}" onsubmit="return xar_base_formCheck(this, mail_fieldRequired, mail_fieldDescription);" enctype="application/x-www-form-urlencoded">

            {# <!-- General tab --> #}
            {% if tab == 'general' %}
                <fieldset>
                    <legend>General options</legend>
                    {{ xar_data_form({object: module_settings}) }}
                </fieldset>
                <fieldset>
                    <legend>Mail Configuration</legend>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Admin Name is the name that emails generated by Xaraya will use in the from field.' %}
                            <label for="admin_outgoing" title="{{ label }}" class="xar-form-label">
                                Mail admin:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set curadmin = xar_var({scope: "module", module: "mail", name: "admin_outgoing"}) %}
                            {{ xar_data_input({name: "admin_outgoing", value: curadmin, type: "userlist", group_list: "Administrators", onchange: "this.form.submit()"}) }}
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Admin Email is the email address that emails generated by Xaraya will use in the from field.' %}
                            <label for="adminmail" title="{{ label }}" class="xar-form-label">
                                Admin email:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set adminmail = xar_var({scope: "user", name: "email", user: curadmin}) %}
                            {{ xar_data_output({type: "email", name: "adminmail", value: adminmail}) }}
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'If you would like a different reply to address attached to emails that are generated by Xaraya, check this box.' %}
                            <label for="replyto" title="{{ label }}" class="xar-form-label">
                                Add different reply-to
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set replyto = xar_var({scope: "module", module: "mail", name: "replyto"}) %}
                            {{ xar_data_input({type: "checkbox", name: "replyto", checked: replyto, onchange: "this.form.submit();"}) }}
                        </div>
                    </div>
                    {% if replyto %}
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter your reply-to name which will be attached to emails addressed to you.' %}
                                <label for="replytoname" title="{{ label }}" class="xar-form-label">
                                    Reply-to name:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set replytoname = xar_var({scope: "module", module: "mail", name: "replytoname"}) %}
                                {{ xar_data_input({type: "textbox", name: "replytoname", value: replytoname}) }}
                            </div>
                        </div>
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter your reply-to email address which will be attached to emails addressed to you.' %}
                                <label for="replytoemail" title="{{ label }}" class="xar-form-label">
                                    Reply-to address:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set replytoemail = xar_var({scope: "module", module: "mail", name: "replytoemail"}) %}
                                {{ xar_data_input({type: "email", name: "replytoemail", value: replytoemail}) }}
                            </div>
                        </div>
                    {% endif %}
                    <div class="xar-row">
                        <div class="xar-col">
                            <label for="showtemplates" title="{{ xar_translate('If you would like the names of the templates used displayed in the emails, check this box.') }}" class="xar-form-label">
                                Show templates used in emails
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set showtemplates = xar_var({scope: "module", module: "mail", name: "ShowTemplates"}) %}
                            {{ xar_data_input({type: "checkbox", name: "showtemplates", checked: showtemplates}) }}&#160;(useful for debugging, normally off)
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Debugging</legend>
                    If debug mode is active, exception messages are visible to the debug administrators, which are defined <a href="{{ xar_moduleurl('roles','admin','modifyconfig',{'tab': 'debugging'}) }}">here</a>.
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Debug mode' %}
                            <label for="checked" title="{{ label }}" class="xar-form-label">            
                                Enable debug mode:            
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set checked = xar_modvar('mail', 'debugmode') %}
                            {{ xar_data_input({type: "checkbox", name: "debugmode", checked: checked}) }}
                        </div>
                    </div>
                </fieldset>
                {# @todo to be checked in function #}
                {% set library_exists = file_exists(xar_coremethod('sys', 'lib') ~ 'PHPMailer') %}
                {% if library_exists %}
                    <fieldset>
                        <legend>PHPMailer</legend>
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Send mail with through an external PHPMailer library in the lib directory' %}
                                <label for="use_external_lib" title="{{ label }}" class="xar-form-label">
                                    Use a newer version of PHPMailer
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set value = xar_var({scope: "module", module: "mail", name: "use_external_lib"}) %}
                                {{ xar_data_input({name: "use_external_lib", value: value, type: "checkbox"}) }}
                                &#160;(the PHPMailer library must be present in the lib directory)
                            </div>
                        </div>
                    </fieldset>
                {% endif %}
                <input type="hidden" name="tab" id="tab" value="{{ tab }}"/>
                {{ include('@base/includes/update-button.html.twig') }}
            {% elseif tab == 'outgoing' %}
                {# <!-- Outgoing tab --> #}
                <fieldset>
                    <legend>HTML options</legend>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Check this box if you would like Xaraya to send HTML formatted emails rather than plain text.' %}
                            <label for="html" title="{{ label }}" class="xar-form-label">
                                Send HTML emails
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set htmlmail = xar_var({scope: "module", module: "mail", name: "html"}) %}
                            {{ xar_data_input({type: "checkbox", name: "html", checked: htmlmail}) }}
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Check this box if you would like to setup HTML headers and footers on the HTML email you send out.' %}
                            <label for="htmluseheadfoot" title="{{ label }}" class="xar-form-label">
                                Use HTML header/footer
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set htmluseheadfoot = xar_var({scope: "module", module: "mail", name: "htmluseheadfoot"}) %}
                            {{ xar_data_input({type: "checkbox", name: "htmluseheadfoot", checked: htmluseheadfoot, onchange: "this.form.submit();"}) }}
                        </div>
                    </div>
                    {% if htmluseheadfoot %}
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter the header that you wish displayed in your HTML emails.' %}
                                <label for="htmlheader" title="{{ label }}" class="xar-form-label">
                                    HTML email header:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set htmlheader = xar_var({scope: "module", module: "mail", name: "htmlheader"}) %}
                                {{ xar_data_input({type: "textarea_large", name: "htmlheader", value: htmlheader}) }}
                            </div>
                        </div>
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter the footer that you wish displayed in your HTML emails.' %}
                                <label for="htmlfooter" title="{{ label }}" class="xar-form-label">HTML Email Footer:</label>
                            </div>
                            <div class="xar-col">
                                {% set htmlfooter = xar_var({scope: "module", module: "mail", name: "htmlfooter"}) %}
                                {{ xar_data_input({type: "textarea_large", name: "htmlfooter", value: htmlfooter}) }}
                            </div>
                        </div>
                    {% endif %}
                </fieldset>
                <fieldset>
                    <legend>Text options</legend>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Enter the default word wrap for text email messages.' %}
                            <label for="wordwrap" title="{{ label }}" class="xar-form-label">
                                Default word wrap size:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set wordwrap = xar_var({scope: "module", module: "mail", name: "wordwrap"}) %}
                            {{ xar_data_input({type: "integerbox", name: "wordwrap", value: wordwrap}) }}
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Enter the priority to send messages.' %}
                            <label for="priority" title="{{ label }}" class="xar-form-label">
                                Default message priority:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set priority = xar_var({scope: "module", module: "mail", name: "priority"}) %}
                            {% set options = [
                                    {'id': 1, 'name': xar_translate('High')},
                                    {'id': 3, 'name': xar_translate('Normal')},
                                    {'id': 5, 'name': xar_translate('Low')}
                                ] %}
                            {{ xar_data_input({type: "dropdown", name: "priority", value: priority, options: options}) }}
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Enter the encoding to send messages.' %}
                            <label for="encoding" title="{{ label }}" class="xar-form-label">Default encoding:</label>
                        </div>
                        <div class="xar-col">
                            {% set options = [
                                    {'id': '7bit', 'name': xar_translate('7-bit')},
                                    {'id': '8bit', 'name': xar_translate('8-bit')},
                                    {'id': 'binary', 'name': xar_translate('binary')},
                                    {'id': 'quoted-printable', 'name': xar_translate('quoted-printable')},
                                    {'id': 'base64', 'name': xar_translate('base64')}
                                ] %}
                            {{ xar_data_input({type: "dropdown", value: encoding, name: "encoding", options: options}) }}
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Check this box if you would like to setup text headers and footers on the text emails you send out.' %}
                            <label for="textuseheadfoot" title="{{ label }}" class="xar-form-label">
                                Use text header/footer
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set textuseheadfoot = xar_var({scope: "module", module: "mail", name: "textuseheadfoot"}) %}
                            {{ xar_data_input({type: "checkbox", name: "textuseheadfoot", onchange: "this.form.submit()", checked: textuseheadfoot}) }}
                        </div>
                    </div>
                    {% if xar_modvar('mail', 'textuseheadfoot') %}
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter the header that you wish displayed in your HTML emails.' %}
                                <label for="textheader" title="{{ label }}" class="xar-form-label">
                                    Text email header:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set textheader = xar_var({scope: "module", module: "mail", name: "textheader"}) %}
                                {{ xar_data_input({type: "textarea_large", name: "textheader", value: textheader}) }}
                            </div>
                        </div>
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter the footer that you wish displayed in your HTML emails.' %}
                                <label for="textfooter" title="{{ label }}" class="xar-form-label">
                                    Text email footer:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set textfooter = xar_var({scope: "module", module: "mail", name: "textfooter"}) %}
                                {{ xar_data_input({type: "textarea_large", name: "textfooter", value: textfooter}) }}
                            </div>
                        </div>
                    {% endif %}
                </fieldset>
                <fieldset>
                    <legend>Other display options</legend>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Checking this box changes URLs of images to embedded images' %}
                            <label for="html" title="{{ label }}" class="xar-form-label">
                                Embed images
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set embed_images = xar_var({scope: "module", module: "mail", name: "embed_images"}) %}
                            {{ xar_data_input({type: "checkbox", name: "embed_images", checked: embed_images}) }}
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Sending server options</legend>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Select the default method to send mail Mail should work in most cases, however Windows installs might need to use the SMTP method.' %}
                            <label for="server" title="{{ label }}" class="xar-form-label">
                                Default method to send mail:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set server = xar_var({scope: "module", module: "mail", name: "server"}) %}
                            {% set options = [
                                    {'id': 'smtp', 'name': xar_translate('SMTP-server')},
                                    {'id': 'qmail', 'name': xar_translate('QMail')},
                                    {'id': 'mail', 'name': xar_translate('Mail')},
                                    {'id': 'sendmail', 'name': xar_translate('SendMail')}
                                ] %}
                            {{ xar_data_input({type: "dropdown", name: "server", value: server, onchange: "this.form.submit()", options: options}) }}
                        </div>
                    </div>
                    {% if server == 'sendmail' %}
                        <div class="xar-row">
                            <div class="xar-col">
                                {{ xar_data_input({type: "static", value: "Path to Sendmail:"}) }}
                                {% set label = 'Enter the path to sendmail.' %}
                                <label for="sendmailpath" title="{{ label }}" class="xar-form-label">
                                    Path to Sendmail:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set sendmailpath = xar_var({scope: "module", module: "mail", name: "sendmailpath"}) %}
                                {{ xar_data_input({type: "textbox", name: "sendmailpath", value: sendmailpath}) }}
                            </div>
                        </div>
                    {% endif %}
                    {% if server == 'smtp' %}
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter your SMTP host name: IE mail.xaraya.com.' %}
                                <label for="smtpHost" title="{{ label }}" class="xar-form-label">
                                    SMTP host:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set smtpHost = xar_var({scope: "module", module: "mail", name: "smtpHost"}) %}
                                {{ xar_data_input({type: "textbox", name: "smtpHost", value: smtpHost}) }}
                            </div>
                        </div>
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'Enter your SMTP port.' %}
                                <label for="smtpPort" title="{{ label }}" class="xar-form-label">
                                    SMTP port:
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set smtpPort = xar_var({scope: "module", module: "mail", name: "smtpPort"}) %}
                                {{ xar_data_input({type: "integerbox", name: "smtpPort", value: smtpPort}) }}
                            </div>
                        </div>
                        <div class="xar-row">
                            <div class="xar-col">
                                {% set label = 'If your SMTP server requires authentification, check the box.' %}
                                <label for="smtpAuth" title="{{ label }}">
                                    SMTP Requires Authentication
                                </label>
                            </div>
                            <div class="xar-col">
                                {% set smtpAuth = xar_var({scope: "module", module: "mail", name: "smtpAuth"}) %}
                                {{ xar_data_input({type: "checkbox", name: "smtpAuth", checked: smtpAuth, onchange: "this.form.submit();"}) }}
                            </div>
                        </div>
                        {% if xar_modvar('mail', 'smtpAuth') %}
                            <div class="xar-row">
                                <div class="xar-col">
                                    {% set label = 'Enter your SMTP username.' %}
                                    <label for="smtpUserName" title="{{ label }}" class="xar-form-label">
                                        SMTP username:
                                    </label>
                                </div>
                                <div class="xar-col">
                                    {% set smtpUserName = xar_var({scope: "module", module: "mail", name: "smtpUserName"}) %}
                                    {{ xar_data_input({type: "textbox", name: "smtpUserName", value: smtpUserName}) }}
                                </div>
                            </div>
                            <div class="xar-row">
                                <div class="xar-col">
                                    {% set label = 'Enter your new SMTP password.' %}
                                    <label for="smtpPassword" title="{{ label }}" class="xar-form-label">
                                        SMTP password:
                                    </label>
                                </div>
                                <div class="xar-col">
                                    {% set smtpPassword = xar_var({scope: "module", module: "mail", name: "smtpPassword"}) %}
                                    {{ xar_data_input({type: "password", name: "smtpPassword", value: smtpPassword}) }}
                                </div>
                            </div>
                            <div class="xar-row">
                                <div class="xar-col">
                                    {% set label = 'Enter the type of secure connection' %}
                                    <label for="smtpSecure" title="{{ label }}" class="xar-form-label">
                                        Secure connection:
                                    </label>
                                </div>
                                <div class="xar-col">
                                    {% set smtpSecure = xar_var({scope: "module", module: "mail", name: "smtpSecure"}) %}
                                    {% set options = [
                                            {'id': '', 'name': xar_translate('None')},
                                            {'id': 'ssl', 'name': xar_translate('ssl')},
                                            {'id': 'tls', 'name': xar_translate('tls')}
                                        ] %}
                                    {{ xar_data_input({type: "dropdown", name: "smtpSecure", value: smtpSecure, options: options}) }}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Specify the interval to check for mails to send.' %}
                            <label for="interval" title="{{ label }}" class="xar-form-label">
                                Scheduled mail:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% if xar_coremethod('xarMod', 'isAvailable', 'scheduler') %}
                                {{ xar_data_input({type: "dropdown", name: "interval", options: intervals, value: interval}) }}
                            {% else %}
                                {{ xar_data_input({type: "hidden", name: "interval"}) }}
                                You need to install the Scheduler module for this
                            {% endif %}
                        </div>
                    </div>
                    {% if unsent %}
                        <p>
                          Mails scheduled: {{ unsent }}
                        </p>
                        <p>
                            Please note that if you stop the scheduler or if it isn't triggered, previously scheduled mails will not be sent.
                        </p>
                    {% endif %}
                </fieldset>
                <fieldset class="xar-clearboth">
                    <legend>Filtering Options</legend>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Enter each string on a single line. Do not separate with comma, etc. Best use is %%string%% to ensure no conflict exists.' %}
                            <label for="searchstrings" title="{{ label }}" class="xar-form-label">
                                Strings for search:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set searchstrings = xar_unserialize(xar_modvar('mail', 'searchstrings')) %}
                            {{ xar_data_input({type: "textarea_medium", name: "searchstrings", value: searchstrings}) }}
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Enter each string on a single line in the same order as the search.  Do not separate with comma, etc.' %}
                            <label for="replacestrings" title="{{ label }}" class="xar-form-label">
                                Strings for replacement:
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set replacestrings = xar_unserialize(xar_modvar('mail', 'replacestrings')) %}
                            {{ xar_data_input({type: "textarea_medium", name: "replacestrings", value: replacestrings}) }}
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Debugging</legend>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Check this box if you want to send all emails to a fixed address.' %}
                            <label for="redirectsending" title="{{ label }}" class="xar-form-label">
                                Redirect emails
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set checked = xar_var({scope: "module", module: "mail", name: "redirectsending"}) %}
                            {{ xar_data_input({type: "checkbox", name: "redirectsending", checked: checked}) }}&#160;(emails are redirected to the email address below)
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Redirect Address is the email address that all emails are sent to in debugging mode.' %}
                            <label for="redirectaddress" title="{{ label }}" class="xar-form-label">
                                Redirect addresses:
                            </label>
                        </div>
                        <div class="xar-col" style="vertical-align: top">
                            {% set value = xar_var({scope: "module", module: "mail", name: "redirectaddress"}) %}
                            Enter one or more email addresses separated by commas<br/>
                            {{ xar_data_input({type: "textarea", name: "redirectaddress", value: value, rows: "5", cols: "20"}) }}
                        </div>
                        <div class="xar-col">
                        </div>
                    </div>
                    <div class="xar-row">
                        <div class="xar-col">
                            {% set label = 'Check this box if you want to suppress email sending for testing purposes.' %}
                            <label for="suppresssending" title="{{ label }}" class="xar-form-label">
                                Suppress emails
                            </label>
                        </div>
                        <div class="xar-col">
                            {% set checked = xar_var({scope: "module", module: "mail", name: "suppresssending"}) %}
                            {{ xar_data_input({type: "checkbox", name: "suppresssending", checked: checked}) }}
                        </div>
                    </div>
                </fieldset>
                <input type="hidden" name="tab" id="tab" value="{{ tab }}"/>
                {{ include('@base/includes/update-button.html.twig') }}
            {% elseif tab == 'managehooks' %}
                {# <!-- Hooks tab --> #}
                <fieldset>
                    <legend>
                        Configure Mail Hooks
                    </legend>
                    {% set url = xar_moduleurl('mail','admin','modifyconfig',{'tab': 'managehooks'}) %}
                    {{ xar_guifunc("modules", "admin", "hooks", {main: "false", curhook: "mail", return_url: url}) }}
                </fieldset>
            {% endif %}
        </form>
    </div>
{% endblock %}